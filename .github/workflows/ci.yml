name: Continuous Integration

# Triggers: Executa em push e pull_request para a branch main
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Job Backend: Linting, Testes e Cobertura (RNF-07: >= 70%)
  backend-ci:
    name: Backend CI (Python/Django)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./Project/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Python 3.10+ para Django
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Cache pip para acelerar instalação de dependências (estratégia de cache pip)
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Instala dependências do backend
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest pytest-cov

      # Linting com flake8: Falha em erros críticos
      - name: Lint Backend (flake8)
        run: |
          # Verifica erros críticos (E9**, F63*, F82*)
          flake8 . --count --select=E9,F63,F82 --show-source --statistics
          # Verifica all style issues com max-line-length customizado
          flake8 . --count --max-line-length=120 --statistics

      # Testes com pytest: RNF-07 - Falha obrigatoriamente se cobertura < 70%
      - name: Test Backend with Coverage (RNF-07: >= 70%)
        run: |
          # pytest --cov=./ --cov-fail-under=70 executa testes e valida cobertura mínima
          pytest --cov=api --cov-report=term-missing --cov-fail-under=70

      # Upload de relatório de cobertura (opcional, útil para análise)
      - name: Upload Coverage Report
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          fail_ci_if_error: false

  # Job Frontend: Build e Linting (Node.js/React)
  frontend-ci:
    name: Frontend CI (React/Node.js)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./Project/frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js 18+ para React
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Cache npm para acelerar instalação de dependências (estratégia de cache npm)
      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # Instala dependências do frontend
      - name: Install frontend dependencies
        run: npm ci

      # Linting com eslint: Falha em erros críticos
      - name: Lint Frontend (eslint)
        run: |
          # Verifica erros de linting (quebra o pipeline se houver erros)
          npm run lint 2>&1 || exit 1
        continue-on-error: false

      # Build do React: Valida que o código compila corretamente
      - name: Build Frontend
        run: |
          # npm run build executa Vite build e falha se houver erros de compilação
          npm run build
