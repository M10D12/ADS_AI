name: Release and Deploy

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # ========================================================================
  # Create Release Build
  # ========================================================================
  create-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: tag_version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          VERSION="0.1.0-$(date +%Y%m%d-%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi

    - name: Create release notes
      run: |
        mkdir -p release-notes
        echo "# Release ${{ steps.tag_version.outputs.version }}" > release-notes/RELEASE.md
        echo "" >> release-notes/RELEASE.md
        echo "## Date: $(date)" >> release-notes/RELEASE.md
        echo "" >> release-notes/RELEASE.md
        echo "### Features" >> release-notes/RELEASE.md
        echo "- RecomendaÃ§Ãµes Personalizadas (RF-10)" >> release-notes/RELEASE.md
        echo "- AutenticaÃ§Ã£o JWT" >> release-notes/RELEASE.md
        echo "- GestÃ£o de Favoritos" >> release-notes/RELEASE.md
        echo "- Sistema de AvaliaÃ§Ãµes" >> release-notes/RELEASE.md
        echo "" >> release-notes/RELEASE.md
        echo "### Backend" >> release-notes/RELEASE.md
        echo "- Django 4.2" >> release-notes/RELEASE.md
        echo "- PostgreSQL 17" >> release-notes/RELEASE.md
        echo "" >> release-notes/RELEASE.md
        echo "### Frontend" >> release-notes/RELEASE.md
        echo "- React 18.2.0" >> release-notes/RELEASE.md
        echo "- Vite 5.0.0" >> release-notes/RELEASE.md

    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release-notes/

  # ========================================================================
  # Build Docker Images for Release
  # ========================================================================
  build-release-images:
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="0.1.0"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build backend image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        tags: |
          project-backend:${{ steps.version.outputs.version }}
          project-backend:latest
        push: false

    - name: Build frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        tags: |
          project-frontend:${{ steps.version.outputs.version }}
          project-frontend:latest
        push: false

  # ========================================================================
  # Health Check
  # ========================================================================
  health-check:
    runs-on: ubuntu-latest
    needs: build-release-images

    steps:
    - name: Verify build artifacts
      run: |
        echo "âœ… Release build completed successfully"
        echo "Version: ${{ needs.create-release.outputs.version }}"

  # ========================================================================
  # Deployment Notification
  # ========================================================================
  notify-release:
    runs-on: ubuntu-latest
    if: always()
    needs: [ create-release, build-release-images, health-check ]

    steps:
    - name: Release deployment status
      run: |
        if [ "${{ needs.health-check.result }}" == "success" ]; then
          echo "âœ… Release deployment pipeline completed successfully!"
          echo ""
          echo "ðŸ“¦ Docker Images:"
          echo "  - Backend: project-backend:latest"
          echo "  - Frontend: project-frontend:latest"
          echo ""
          echo "ðŸ”— Documentation:"
          echo "  - API Docs: https://api.example.com/docs"
          echo "  - Frontend: https://example.com"
        fi
